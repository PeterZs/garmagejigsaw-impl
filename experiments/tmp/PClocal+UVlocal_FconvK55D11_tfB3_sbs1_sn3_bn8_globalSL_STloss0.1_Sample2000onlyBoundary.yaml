# sh experiments/tmp/tmp_train_stylexd_onDocker.sh  experiments/tmp/PClocal+UVlocal_FconvK55D11_tfB3_sbs1_sn3_bn8_globalSL_STloss0.1_Sample2000onlyBoundary.yaml
# run on 188
# 将这个ckpt继续训练200个epoch results/PClocal+UVlocal_FconvK55D11_tfB3_sbs1_sn3_bn8_globalSL_STloss0.1_Sample2000onlyBoundary/model_save/model_epoch=199.ckpt

MODEL_NAME: jigsaw_StyleXD
MODULE: jigsaw_stylexd

PROJECT: jigsaw

WEIGHT_FILE: results/jigsaw_StyleXD/model_save/last-v6.ckpt

RESUME: true
WANDB:
  ID: htz2km7a

GPUS: [0]
BATCH_SIZE: 8
NUM_WORKERS: 8

TRAIN:
  NUM_EPOCHS: 50
  LR: 0.000013
  WEIGHT_DECAY: 0.
  WARMUP_RATIO: 0.
  LR_SCHEDULER: 'cosine' 
  LR_DECAY: 10.
  VAL_EVERY: 1
  FINETUNE: True

MODEL:
  USE_POINT_FEATURE: True   # Whether to extract point features
  USE_LOCAL_POINT_FEATURE: True    
  USE_GLOBAL_POINT_FEATURE: False  
  USE_UV_FEATURE: True      # Whether to extract uv features
  USE_LOCAL_UV_FEATURE: True       
  USE_GLOBAL_UV_FEATURE: False     

  ENCODE_ALL_ONCE: False  #  Use the same encoder to extract all features

  FEATURE_CONV:  # Feature conv before Pointtransformer
    USE_FEATURE_CONV: True
    TYPE: "default"
    LAYER_NUM: 1
    KERNEL_SIZE: 5
    DILATION: 1

  FEATURE_CONV_2:  # Feature conv after Pointtransformer
    USE_FEATURE_CONV: False
    TYPE: "default"
    LAYER_NUM: 1
    KERNEL_SIZE: 5
    DILATION: 1

  # PointTransformer
  TF_LAYER_NUM: 3     # Layer\Block num of PointTransformer
  USE_TF_BLOCK: True  
  TF:
    NORM: "batch"

  POINTCLASSIFIER:
    NORM: "instance"
  STITCHPREDICTOR:
    NORM: "instance"

  PC_CLS_THRESHOLD: 0.5
  LOSS:
    MAT_LOSS_TYPE: "global"  # "local" OR "global"
    MAT_LOSS_SYM: True       # train model predict symmetrical stitching mat
    w_cls_loss: 1.0
    w_mat_loss: 0.1

CALLBACK:
  CHECKPOINT_MONITOR: val/mat_f1
  CHECKPOINT_MODE: max

DATA:
  DATA_DIR: "/home/data/StyleXD/preprocessed_jigsaw"
  DATASET_SPLIT_DIR: "/home/data/StyleXD/preprocessed_jigsaw/dataset_split_Q124_1_02_1_maxpanel32_maxcontour7/"  # dataset_split dataset_split_Q4finetune dataset_split_trousers
  DATA_TYPES:
    INFERENCE: ["Garmage256_SL"]

  NUM_PC_POINTS: 2000

  SHUFFLE: True  

  MAX_NUM_PART: 64
  MIN_PART_POINT: 10

  PCS_SAMPLE_TYPE:  
    TRAIN: stitch
    VAL: stitch
    INFERENCE: boundary_pcs
    STITCH:
      ONLY_SAMPLE_BOUNDARY: True  # Not sample stitching point inside panels if set true.

  SHRINK_MESH:
    TRAIN: True
    VAL: True
    INFERENCE: False
  SHRINK_MESH_PARAM:
    TRAIN: 0.8
    VAL: 0.8
    INFERENCE: 1
  SHRINK_BYSTITCH:
    TRAIN: True
    VAL: True
    INFERENCE: False
  SHRINK_BYSTITCH_STRENGTH:
    TRAIN: 1
    VAL: 1
    INFERENCE: 0

  USE_STITCH_NOISE: True  # Stitching noise for augment
  STITCH_NOISE_STRENGTH: 3.
  STITCH_NOISE_RANDOM_RANGE: [-1.0, 1.]  # [-1., 1.]

  PANEL_NOISE_TYPE:  # Panel noise for augment
    TRAIN: bbox
    VAL: bbox
    INFERENCE: default  # default OR bbox
  SCALE_RANGE: 0.07
  ROT_RANGE: 3
  TRANS_RANGE: 6
  BBOX_NOISE_STRENGTH: 8

# STATS is for eval
STATS: "./results/jigsaw_4x4_128_512_250e_cosine_everyday/stats/eval"
